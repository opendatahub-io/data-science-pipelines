name: "Deploy Data Science Pipelines"
description: "Enhanced deployment with DSPO and PyPI server support"

inputs:
  # Image configuration
  image_tag:
    default: "latest"
    required: true
    description: "Provide the image tag your image was tagged with"
  image_path:
    required: true
    description: "Path within github artifacts where your image tarball is stored"
  image_registry:
    default: "kind-registry:5000"
    required: true
    description: "Image Registry address of the images"

  # Operator deployment options
  deploy_pypi_server:
    description: "Deploy PyPI server for Python packages"
    required: false
    default: 'false'
  deploy_external_argo:
    description: "Deploy Argo Workflows externally in separate namespace"
    required: false
    default: 'false'

  # Existing KFP options
  pipeline_store:
    description: "Flag to deploy KFP with K8s Native API"
    default: 'database'
    required: false
  proxy:
    description: "If KFP should be deployed with proxy configuration"
    required: false
    default: 'false'
  cache_enabled:
    description: "If KFP should be deployed with cache enabled globally"
    required: false
    default: 'true'
  multi_user:
    description: "If KFP should be deployed in multi-user mode"
    required: false
    default: 'false'
  artifact_proxy:
    description: "Enables artifact proxy"
    required: false
    default: 'false'
  storage_backend:
    description: "Storage backend to use (minio or seaweedfs)"
    required: false
    default: 'seaweedfs'
  argo_version:
    required: false
    default: 'v3.6.7'
    description: "Argo version to use for the cluster"
  forward_port:
    required: false
    default: 'true'
    description: "If you want to forward API server port to localhost:8888"
  pod_to_pod_tls_enabled:
    description: "If KFP should be deployed with TLS pod-to-pod communication."
    required: false
    default: 'true'
  namespace:
    description: "Namespace for DSPA deployment"
    required: false
    default: 'kubeflow'

runs:
  using: "composite"
  steps:
    - name: Deploy Squid
      id: deploy-squid
      if: ${{ inputs.proxy == 'true' }}
      shell: bash
      run: ./.github/resources/squid/deploy-squid.sh

    - name: Download Docker Images
      uses: actions/download-artifact@v4
      with:
        path: "images_${{ github.sha }}"

    - name: Load Docker Images
      shell: bash
      run: |
        APPS=("apiserver" "driver" "launcher" "scheduledworkflow" "persistenceagent" "frontend" "metadata-writer"  )
        for app in "${APPS[@]}"; do
          docker image load -i ${{ inputs.image_path }}/$app/$app.tar
          docker push ${{ inputs.image_registry }}/$app:${{ inputs.image_tag }}
          rm ${{ inputs.image_path }}/$app/$app.tar
          docker image rm ${{ inputs.image_registry }}/$app:${{ inputs.image_tag }}
        done

    - name: Install Python Dependencies
      shell: bash
      run: |
        pip3 install pyyaml

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: 'stable'  # Uses latest stable Go version

    - name: Deploy Data Science Pipelines
      shell: bash
      run: |
        # Handle empty inputs by using defaults
        PIPELINE_STORE="${{ inputs.pipeline_store }}"
        STORAGE_BACKEND="${{ inputs.storage_backend }}"
        NAMESPACE="${{ inputs.namespace }}"
        PROXY="${{ inputs.proxy }}"
        POD_TO_POD_TLS_ENABLED="${{ inputs.pod_to_pod_tls_enabled }}"

        # Use defaults if empty
        PIPELINE_STORE=${PIPELINE_STORE:-"database"}
        STORAGE_BACKEND=${STORAGE_BACKEND:-"seaweedfs"}
        NAMESPACE=${NAMESPACE:-"kubeflow"}
        PROXY=${PROXY:-"false"}
        POD_TO_POD_TLS_ENABLED=${POD_TO_POD_TLS_ENABLED:-"true"}

        python3 ./.github/actions/deploy/deploy.py \
          --github-repository "${{ github.repository }}" \
          --github-base-ref "${{ github.base_ref }}" \
          --image-tag "${{ inputs.image_tag }}" \
          --image-registry "${{ inputs.image_registry }}" \
          --deploy-pypi-server "${{ inputs.deploy_pypi_server }}" \
          --deploy-external-argo "${{ inputs.deploy_external_argo }}" \
          --pipeline-store "$PIPELINE_STORE" \
          --proxy "$PROXY" \
          --cache-enabled "${{ inputs.cache_enabled }}" \
          --multi-user "${{ inputs.multi_user }}" \
          --artifact-proxy "${{ inputs.artifact_proxy }}" \
          --storage-backend "$STORAGE_BACKEND" \
          --argo-version "${{ inputs.argo_version }}" \
          --forward-port "${{ inputs.forward_port }}" \
          --pod-to-pod-tls-enabled "$POD_TO_POD_TLS_ENABLED" \
          --namespace "$NAMESPACE"
